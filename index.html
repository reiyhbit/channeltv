<!DOCTYPE html>
<html>
<head>
    <title>OTT Player - Working Version</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .player-container { max-width: 1000px; margin: 0 auto; }
        video { width: 100%; height: 400px; background: #000; border-radius: 10px; }
        .channels { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; margin-top: 20px; }
        .channel { background: #2d2d2d; padding: 15px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
        .channel:hover { border-color: #ff4444; }
        .channel.playing { border-color: #44ff44; background: #3d3d3d; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .loading { background: #0066cc; }
        .error { background: #cc0000; }
        .success { background: #00cc00; }
    </style>
</head>
<body>
    <div class="player-container">
        <h1>ðŸŽ¬ OTT Style Player</h1>
        
        <div id="status" class="status">Click any channel to play</div>
        
        <video id="video" controls playsinline preload="auto">
            Your browser doesn't support HTML5 video.
        </video>

        <div id="channels" class="channels">
            <div>Loading channels...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        class WorkingPlayer {
            constructor() {
                this.video = document.getElementById('video');
                this.channelsDiv = document.getElementById('channels');
                this.statusDiv = document.getElementById('status');
                this.hls = null;
                this.channels = [];
                
                this.init();
            }

            async init() {
                await this.loadPlaylist();
            }

            setStatus(message, type = '') {
                this.statusDiv.textContent = message;
                this.statusDiv.className = `status ${type}`;
            }

            async loadPlaylist() {
                this.setStatus('ðŸ“¡ Loading playlist...', 'loading');
                
                try {
                    // Try direct fetch first
                    const response = await fetch('https://mc-o0of718lw0.bunny.run/playlist.m3u8');
                    const text = await response.text();
                    
                    this.parsePlaylist(text);
                    this.setStatus('âœ… Playlist loaded! Click any channel to play', 'success');
                    
                } catch (error) {
                    this.setStatus('âŒ Failed to load playlist', 'error');
                    console.error('Playlist error:', error);
                }
            }

            parsePlaylist(text) {
                const lines = text.split('\n');
                this.channels = [];
                let currentChannel = {};

                lines.forEach(line => {
                    line = line.trim();
                    
                    if (line.startsWith('#EXTINF:')) {
                        // Extract channel name
                        const nameMatch = line.match(/,(.*)$/);
                        if (nameMatch) {
                            currentChannel.name = nameMatch[1].trim();
                            
                            // Extract logo if available
                            const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                            currentChannel.logo = logoMatch ? logoMatch[1] : '';
                        }
                    } else if (line.startsWith('http')) {
                        currentChannel.url = line;
                        if (currentChannel.name) {
                            this.channels.push({...currentChannel});
                        }
                        currentChannel = {};
                    }
                });

                this.displayChannels();
            }

            displayChannels() {
                this.channelsDiv.innerHTML = '';
                
                this.channels.forEach((channel, index) => {
                    const channelEl = document.createElement('div');
                    channelEl.className = 'channel';
                    channelEl.innerHTML = `
                        <strong>${channel.name}</strong>
                        ${channel.logo ? `<br><small>ðŸ“º ${channel.logo}</small>` : ''}
                    `;
                    
                    channelEl.onclick = () => this.playChannel(channel, channelEl);
                    this.channelsDiv.appendChild(channelEl);
                });
            }

            playChannel(channel, element) {
                this.setStatus(`ðŸ”„ Loading: ${channel.name}`, 'loading');
                
                // Update UI
                document.querySelectorAll('.channel').forEach(el => {
                    el.classList.remove('playing');
                });
                element.classList.add('playing');

                // Clean up previous HLS instance
                if (this.hls) {
                    this.hls.destroy();
                }

                // Try different playback methods
                this.tryPlaybackMethods(channel);
            }

            async tryPlaybackMethods(channel) {
                // Method 1: Native HLS (Safari)
                if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
                    this.video.src = channel.url;
                    this.video.addEventListener('loadeddata', () => {
                        this.setStatus(`â–¶ï¸ Now Playing: ${channel.name}`, 'success');
                    });
                    this.video.addEventListener('error', (e) => {
                        this.tryHlsJs(channel); // Fallback to HLS.js
                    });
                    return;
                }

                // Method 2: HLS.js
                this.tryHlsJs(channel);
            }

            tryHlsJs(channel) {
                if (!Hls.isSupported()) {
                    this.setStatus('âŒ HLS not supported in this browser', 'error');
                    return;
                }

                this.hls = new Hls({
                    enableWorker: false,
                    lowLatencyMode: true,
                    backBufferLength: 90,
                    debug: false
                });

                this.hls.loadSource(channel.url);
                this.hls.attachMedia(this.video);

                this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    this.video.play();
                    this.setStatus(`â–¶ï¸ Now Playing: ${channel.name}`, 'success');
                });

                this.hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                this.setStatus(`ðŸŒ Network error: ${channel.name}`, 'error');
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                this.setStatus(`ðŸ“º Media error: ${channel.name}`, 'error');
                                break;
                            default:
                                this.setStatus(`âŒ Cannot play: ${channel.name}`, 'error');
                                break;
                        }
                    }
                });
            }
        }

        // Initialize player
        document.addEventListener('DOMContentLoaded', () => {
            new WorkingPlayer();
        });

        // Add error handling for video element
        document.getElementById('video').addEventListener('error', function(e) {
            console.error('Video error:', this.error);
        });
    </script>
</body>
</html>
